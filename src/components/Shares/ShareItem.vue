<!--
  - SPDX-FileCopyrightText: 2018 Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { t } from '@nextcloud/l10n'

import VotedIcon from 'vue-material-design-icons/CheckboxMarked.vue'
import UnvotedIcon from 'vue-material-design-icons/MinusBox.vue'

import UserItem from '../User/UserItem.vue'
import ShareMenu from './ShareMenu.vue'

import type { Share } from '../../stores/shares.types'

const emit = defineEmits(['showQrCode'])

const { share, tag = 'div' } = defineProps<{ share: Share; tag?: string }>()

const label = ref({
	inputValue: '',
	inputProps: {
		success: false,
		error: false,
		showTrailingButton: true,
		labelOutside: false,
		label: t('polls', 'Share label'),
	},
})

const userItemProps = computed(() => ({
	user: share.user,
	label: share.label,
	showEmail: true,
	resolveInfo: true,
	forcedDescription: share.deleted ? `(${t('polls', 'deleted')})` : null,
	showTypeIcon: true,
	icon: true,
}))

onMounted(() => {
	label.value.inputValue = share.label
})
</script>

<template>
	<UserItem
		v-bind="userItemProps"
		:class="{ deleted: share.deleted }"
		:tag="tag"
		:delegated-from-group="!share.pollId"
		:deleted-state="share.deleted"
		:locked-state="share.locked">
		<template #status>
			<div v-if="share.voted">
				<VotedIcon
					class="vote-status voted"
					:name="t('polls', 'Has voted')" />
			</div>
			<div
				v-else-if="
					share.groupId || ['public', 'group'].includes(share.type)
				">
				<div class="vote-status empty" />
			</div>
			<div v-else>
				<UnvotedIcon
					class="vote-status unvoted"
					:name="t('polls', 'Has not voted')" />
			</div>
		</template>

		<ShareMenu :share="share" @show-qr-code="emit('showQrCode')" />
	</UserItem>
</template>

<style lang="scss">
.deleted .user-item .description {
	color: var(--color-error-text);
}

.vote-status {
	margin-inline-start: 8px;
	width: 32px;

	&.voted {
		color: var(--color-polls-foreground-yes);
	}

	&.unvoted {
		color: var(--color-polls-foreground-no);
	}
}
</style>
