<!--
  - SPDX-FileCopyrightText: 2018 Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import debounce from 'lodash/debounce'
import { showSuccess, showError } from '@nextcloud/dialogs'
import { t } from '@nextcloud/l10n'

import NcActions from '@nextcloud/vue/components/NcActions'
import NcActionButton from '@nextcloud/vue/components/NcActionButton'
import NcActionCheckbox from '@nextcloud/vue/components/NcActionCheckbox'
import NcActionInput from '@nextcloud/vue/components/NcActionInput'
import NcActionSeparator from '@nextcloud/vue/components/NcActionSeparator'

import SettingsIcon from 'vue-material-design-icons/CogOutline.vue'
import SendLinkPerEmailIcon from 'vue-material-design-icons/LinkVariant.vue'
import DeleteIcon from 'vue-material-design-icons/DeleteOutline.vue'
import ClippyIcon from 'vue-material-design-icons/ClipboardArrowLeftOutline.vue'
import ResetVotesIcon from 'vue-material-design-icons/Undo.vue'
import EditAccountIcon from 'vue-material-design-icons/AccountEditOutline.vue'
import LogoutIcon from 'vue-material-design-icons/Logout.vue'
import EditEmailIcon from 'vue-material-design-icons/EmailEditOutline.vue'

import { ValidatorAPI } from '../../Api'
import { usePollStore } from '../../stores/poll'
import { useSessionStore } from '../../stores/session'
import { useSubscriptionStore } from '../../stores/subscription'
import { useVotesStore } from '../../stores/votes'
import { StatusResults } from '../../Types'
import { deleteCookieByValue, findCookieByValue } from '../../helpers'

interface Props {
	noMenuIcon: boolean
}

type InputProps = {
	success: boolean
	error: boolean
	showTrailingButton: boolean
	labelOutside: boolean
	label: string
}

const { noMenuIcon } = defineProps<Props>()

const pollStore = usePollStore()
const sessionStore = useSessionStore()
const subscriptionStore = useSubscriptionStore()
const votesStore = useVotesStore()
const router = useRouter()
const hasCookie = !!findCookieByValue(sessionStore.publicToken)

/**
 *
 */
function logout() {
	const reRouteTo = deleteCookieByValue(sessionStore.publicToken)
	if (reRouteTo) {
		router.push({
			name: 'publicVote',
			params: {
				token: reRouteTo,
			},
		})
	}
}

/**
 *
 */
async function writeSubscription() {
	subscriptionStore.write()
}

/**
 *
 */
async function deleteEmailAddress() {
	try {
		await sessionStore.deleteEmailAddress()
		showSuccess(t('polls', 'Email address deleted.'))
	} catch {
		showError(
			t('polls', 'Error deleting email address {emailAddress}', {
				emailAddress: sessionStore.share.user.emailAddress,
			}),
		)
	}
}

/**
 *
 */
async function resendInvitation() {
	try {
		const response = await sessionStore.resendInvitation()
		if (response) {
			showSuccess(
				t('polls', 'Invitation resent to {emailAddress}', {
					emailAddress: response.data.share.user.emailAddress,
				}),
			)
		}
	} catch {
		showError(
			t('polls', 'Mail could not be resent to {emailAddress}', {
				emailAddress: sessionStore.share.user.emailAddress,
			}),
		)
	}
}

/**
 *
 */
async function copyLink() {
	const personalLink =
		window.location.origin
		+ router.resolve({
			name: 'publicVote',
			params: { token: sessionStore.publicToken },
		}).href

	try {
		await navigator.clipboard.writeText(personalLink)
		showSuccess(t('polls', 'Link copied to clipboard'))
	} catch {
		showError(t('polls', 'Error while copying link to clipboard'))
	}
}

/**
 *
 */
async function resetVotes() {
	try {
		await votesStore.resetVotes()
		showSuccess(t('polls', 'Your votes are reset'))
	} catch {
		showError(t('polls', 'Error while resetting votes'))
	}
}

const displayNameInputProps = ref<InputProps>({
	success: false,
	error: false,
	showTrailingButton: true,
	labelOutside: false,
	label: t('polls', 'Change name'),
})

const validateDisplayName = debounce(async function () {
	if (sessionStore.share.user.displayName.length < 1) {
		setDisplayNameStatus('error')
		return
	}

	if (
		sessionStore.share.user.displayName === sessionStore.currentUser.displayName
	) {
		setDisplayNameStatus('unchanged')
		return
	}

	try {
		await ValidatorAPI.validateName(
			sessionStore.route.params.token,
			sessionStore.share.user.displayName,
		)
		setDisplayNameStatus('success')
	} catch {
		setDisplayNameStatus('error')
	}
}, 500)

/**
 *
 * @param status
 */
function setDisplayNameStatus(status: StatusResults) {
	displayNameInputProps.value.success = status === 'success'
	displayNameInputProps.value.error = status === 'error'
	displayNameInputProps.value.showTrailingButton = status === 'success'
}

/**
 *
 */
async function submitDisplayName() {
	try {
		await sessionStore.updateDisplayName({
			displayName: sessionStore.share.user.displayName,
		})
		showSuccess(t('polls', 'Name changed.'))
		setDisplayNameStatus('unchanged')
	} catch {
		showError(t('polls', 'Error changing name.'))
		setDisplayNameStatus('error')
	}
}

const eMailInputProps = ref<InputProps>({
	success: false,
	error: false,
	showTrailingButton: true,
	labelOutside: false,
	label: t('polls', 'Edit email address'),
})

const validateEMail = debounce(async function () {
	if (
		sessionStore.share.user.emailAddress
		=== sessionStore.currentUser.emailAddress
	) {
		setEMailStatus('unchanged')
		return
	}

	try {
		await ValidatorAPI.validateEmailAddress(sessionStore.share.user.emailAddress)
		setEMailStatus('success')
	} catch {
		setEMailStatus('error')
	}
}, 500)

/**
 *
 * @param status
 */
function setEMailStatus(status: StatusResults) {
	eMailInputProps.value.success = status === 'success'
	eMailInputProps.value.error = status === 'error'
	eMailInputProps.value.showTrailingButton = status === 'success'
}

/**
 *
 */
async function submitEmail() {
	try {
		await sessionStore.updateEmailAddress({
			emailAddress: sessionStore.share.user.emailAddress,
		})
		showSuccess(
			t('polls', 'Email address {emailAddress} saved.', {
				emailAddress: sessionStore.share.user.emailAddress,
			}),
		)
		setEMailStatus('unchanged')
	} catch {
		showError(
			t('polls', 'Error saving email address {emailAddress}', {
				emailAddress: sessionStore.share.user.emailAddress,
			}),
		)
		setEMailStatus('error')
	}
}
</script>

<template>
	<NcActions v-bind="$attrs">
		<template v-if="!noMenuIcon" #icon>
			<SettingsIcon :size="20" decorative />
		</template>

		<NcActionButton
			v-if="sessionStore.share?.type === 'external'"
			:name="t('polls', 'Copy your personal link to clipboard')"
			:aria-label="t('polls', 'Copy your personal link to clipboard')"
			@click="copyLink()">
			<template #icon>
				<ClippyIcon />
			</template>
		</NcActionButton>

		<NcActionSeparator v-if="sessionStore.share?.type === 'external'" />

		<NcActionInput
			v-if="sessionStore.share?.type === 'external'"
			v-bind="displayNameInputProps"
			v-model="sessionStore.share.user.displayName"
			@update:value-value="validateDisplayName"
			@submit="submitDisplayName">
			<template #icon>
				<EditAccountIcon />
			</template>
			{{ displayNameInputProps.label }}
		</NcActionInput>

		<NcActionInput
			v-if="sessionStore.share?.type === 'external'"
			v-bind="eMailInputProps"
			v-model="sessionStore.share.user.emailAddress"
			@update:model-value="validateEMail"
			@submit="submitEmail">
			<template #icon>
				<EditEmailIcon />
			</template>
			{{ eMailInputProps.label }}
		</NcActionInput>

		<NcActionButton
			v-if="sessionStore.share?.type === 'external'"
			:name="t('polls', 'Get your personal link per mail')"
			:aria-label="t('polls', 'Get your personal link per mail')"
			:disabled="!sessionStore.share.user.emailAddress"
			@click="resendInvitation()">
			<template #icon>
				<SendLinkPerEmailIcon />
			</template>
		</NcActionButton>

		<NcActionCheckbox
			:model-value="subscriptionStore.subscribed"
			:disabled="!pollStore.permissions.subscribe"
			title="check"
			@change="writeSubscription">
			{{ t('polls', 'Subscribe to notifications') }}
		</NcActionCheckbox>

		<NcActionButton
			v-if="
				sessionStore.share?.type === 'external'
				&& sessionStore.share.user.emailAddress
			"
			:name="t('polls', 'Remove email address')"
			:aria-label="t('polls', 'Remove email address')"
			@click="deleteEmailAddress">
			<template #icon>
				<DeleteIcon />
			</template>
		</NcActionButton>

		<NcActionButton
			v-if="pollStore.permissions.vote"
			:name="t('polls', 'Reset your votes')"
			:aria-label="t('polls', 'Reset your votes')"
			@click="resetVotes()">
			<template #icon>
				<ResetVotesIcon />
			</template>
		</NcActionButton>

		<NcActionButton
			v-if="sessionStore.share?.type === 'external' && hasCookie"
			:name="
				t('polls', 'Logout as {name} (delete cookie)', {
					name: sessionStore.currentUser.displayName,
				})
			"
			:aria-label="
				t('polls', 'Logout as {name} (delete cookie)', {
					name: sessionStore.currentUser.displayName,
				})
			"
			@click="logout()">
			<template #icon>
				<LogoutIcon />
			</template>
		</NcActionButton>
	</NcActions>
</template>
